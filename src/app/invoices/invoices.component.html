<form [formGroup]="invoiceForm" (ngSubmit)="onSubmit()" class="p-4">
  <div class="row g-3">
    <div class="col-md-4">
      <label class="form-label fw-semibold">Branch</label>
      <select class="form-select" formControlName="branch">
        <option value="">Select Branch</option>
        <option selected>Karimnagar</option>
        <option selected>Madhapur</option>
        <option selected>Kukatpally</option>
        <option selected>Secunderabad</option>
      </select>
    </div>
    <div class="col-md-4">
      <label class="form-label fw-semibold">Mobile Number</label>
      <input type="text" class="form-control" formControlName="phone" />
    </div>
    <div class="col-md-4">
      <label class="form-label fw-semibold">Customer Name</label>
      <input type="text" class="form-control" formControlName="customer_name" />
    </div>
    <div class="col-md-4">
      <label class="form-label fw-semibold">Email</label>
      <input type="email" class="form-control" formControlName="email" />
    </div>
    <div class="col-md-4">
      <label class="form-label fw-semibold">Exchange</label>
      <input type="text" class="form-control" formControlName="exchange" />
    </div>
    <div class="col-md-8">
      <label class="form-label fw-semibold">Notes</label>
      <textarea
        class="form-control"
        rows="2"
        formControlName="notes"
      ></textarea>
    </div>
  </div>

  <hr class="my-4" />

  <div formArrayName="products">
    <div
      *ngFor="let product of products.controls; let i = index"
      [formGroupName]="i"
      class="card p-3 my-3 border"
    >
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="fw-bold mb-0">Product {{ i + 1 }}</h5>
        <button
          type="button"
          class="btn btn-sm btn-outline-danger"
          (click)="removeProduct(i)"
        >
          <i class="bi bi-trash-fill"></i> Remove Product
        </button>
      </div>

      <div class="row g-3 mb-2">
        <div class="col-md-2">
          <input class="form-control" placeholder="HSN" formControlName="hsn" />
        </div>
        <div class="col-md-2">
          <input
            class="form-control"
            placeholder="Description"
            formControlName="description"
          />
        </div>
        <div class="col-md-2">
          <input class="form-control" placeholder="Qty" formControlName="qty" />
        </div>
        <div class="col-md-2">
          <input
            type="number"
            formControlName="grossWt"
            class="form-control"
            placeholder="Gross.Wt"
          />
        </div>
        <div class="col-md-2">
          <input
            type="number"
            formControlName="calcWt"
            class="form-control"
            placeholder="Calc.Wt"
          />
        </div>
        <div class="col-md-2">
          <input
            class="form-control"
            placeholder="Rate"
            formControlName="rate"
          />
        </div>
        <div class="col-md-2">
          <input
            class="form-control"
            placeholder="Amt"
            formControlName="amount"
          />
        </div>
        <div class="col-md-2">
          <input
            class="form-control"
            placeholder="Purity"
            formControlName="purity"
          />
        </div>
        <div class="col-md-2">
          <input
            class="form-control"
            placeholder="Value"
            formControlName="value"
          />
        </div>
        <div class="col-md-2">
          <input
            class="form-control"
            placeholder="Margin"
            formControlName="margin"
          />
        </div>
      </div>

      <div formArrayName="subItems">
        <h6 class="fw-semibold mt-3">Sub Items</h6>
        <div
          *ngFor="let sub of getSubItems(i).controls; let j = index"
          [formGroupName]="j"
          class="row g-2 mb-2 align-items-end"
        >
          <div class="col-md-4">
            <input
              class="form-control"
              placeholder="Name"
              formControlName="name"
            />
          </div>
          <div class="col-md-3">
            <input
              class="form-control"
              placeholder="Quantity"
              formControlName="quantity"
            />
          </div>
          <div class="col-md-3">
            <input
              class="form-control"
              placeholder="Rate"
              formControlName="rate"
            />
          </div>
          <div class="col-md-2 text-end">
            <button
              type="button"
              class="btn btn-outline-danger btn-sm"
              (click)="removeSubItem(i, j)"
            >
              <i class="bi bi-trash-fill"></i>
            </button>
          </div>
        </div>

        <div class="mt-2">
          <button
            type="button"
            class="btn btn-sm btn-info"
            (click)="addSubItem(i)"
          >
            + Add Sub Item
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="my-3">
    <button type="button" class="btn btn-dark" (click)="addProduct()">
      + Add Product
    </button>
  </div>

  <div class="text-end mt-4">
    <button class="btn btn-secondary me-2" type="reset">Close</button>
    <button class="btn btn-primary" type="submit" (click)="save()">Save</button>
  </div>
</form>
